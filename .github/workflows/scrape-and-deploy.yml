name: Scrape Food Data and Deploy

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]
    paths: 
      - 'scraper/**'
      - 'backend/**'

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    
    # Add explicit permissions for GitHub Pages deployment
    permissions:
      contents: read
      pages: write
      id-token: write
      actions: read
    
    steps:
    - name: Checkout Fastfood repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install scraper dependencies
      run: |
        cd scraper
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run scraper
      run: |
        cd scraper
        python src/main.py
        
    - name: Create data directory for GitHub Pages
      run: |
        mkdir -p gh-pages-data
        cp scraper/enhanced_offers_with_food_info.json gh-pages-data/
        
        # Create a simple index.html for the data repo
        cat > gh-pages-data/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Reykjavik Food Data</title>
            <meta charset="UTF-8">
            <meta http-equiv="refresh" content="30">
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; }
                .container { max-width: 600px; margin: 0 auto; }
                .stats { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
                .download-link { display: inline-block; background: #007cba; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 10px 0; }
                .download-link:hover { background: #005a87; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üçî Reykjavik Food Offers Data</h1>
                <p>This repository hosts the scraped food offer data for the Reykjavik Food Finder app.</p>
                
                <div class="stats">
                    <h3>Latest Data</h3>
                    <p><strong>Last updated:</strong> <span id="lastUpdated">Loading...</span></p>
                    <p><strong>Total offers:</strong> <span id="totalOffers">Loading...</span></p>
                    <p><strong>Restaurants:</strong> <span id="totalRestaurants">Loading...</span></p>
                </div>
                
                <a href="enhanced_offers_with_food_info.json" class="download-link">üì• Download JSON Data</a>
                
                <h3>API Usage</h3>
                <code>https://yourusername.github.io/Fastfood/enhanced_offers_with_food_info.json</code>
                
                <script>
                    fetch('enhanced_offers_with_food_info.json')
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('lastUpdated').textContent = new Date(data.scraped_at).toLocaleString();
                            document.getElementById('totalOffers').textContent = data.total_offers;
                            document.getElementById('totalRestaurants').textContent = data.restaurants.length;
                        })
                        .catch(error => {
                            document.getElementById('lastUpdated').textContent = 'Error loading data';
                            document.getElementById('totalOffers').textContent = 'N/A';
                            document.getElementById('totalRestaurants').textContent = 'N/A';
                        });
                </script>
            </div>
        </body>
        </html>
        EOF
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./gh-pages-data
        publish_branch: gh-pages
        commit_message: 'Update food data - ${{ github.event.head_commit.message || github.event_name }}'
        force_orphan: true  # This helps with initial deployment
        
    - name: Create deployment summary
      run: |
        echo "## üçî Food Data Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Offers found:** $(jq '.total_offers' gh-pages-data/enhanced_offers_with_food_info.json)" >> $GITHUB_STEP_SUMMARY
        echo "- **Restaurants:** $(jq '.restaurants | length' gh-pages-data/enhanced_offers_with_food_info.json)" >> $GITHUB_STEP_SUMMARY
        echo "- **Data URL:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/enhanced_offers_with_food_info.json" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Frontend Setup" >> $GITHUB_STEP_SUMMARY
        echo "Set this environment variable in your reykjavik-food-finder deployment:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "VITE_DATA_URL=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/enhanced_offers_with_food_info.json" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
